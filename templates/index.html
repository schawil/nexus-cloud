<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>NEXUS | Orchestrator</title>
    <link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <script src="{{ url_for('static', filename='js/chart.js') }}"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2563eb;
            --primary-soft: #dbeafe;
            --danger: #dc2626;
            --danger-soft: #fee2e2;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --bg-body: #f1f5f9;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: var(--text-main);
            min-height: 100vh;
        }

        /* --- NAVBAR --- */
        .navbar-glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.5);
            padding: 1.2rem 0;
            position: sticky; top: 0; z-index: 1000;
        }
        .brand { font-weight: 900; font-size: 1.4rem; letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; }
        .brand-logo { 
            background: var(--primary); color: white; width: 32px; height: 32px; 
            border-radius: 8px; display: flex; align-items: center; justify-content: center; 
            font-weight: 900; font-size: 1.1rem;
        }

        /* --- STATS HEADER (BRANDED) --- */
        .stat-card {
            background: white; border-radius: 20px; padding: 24px;
            border: 1px solid white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            display: flex; align-items: center; gap: 20px;
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }
        
        /* C'est ici qu'on met le branding NEXUS dans les cercles */
        .nexus-circle {
            width: 56px; height: 56px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 1.2rem; letter-spacing: -1px;
        }
        .nc-blue { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        .nc-purple { background: #f5f3ff; color: #7c3aed; border: 1px solid #ddd6fe; }
        .nc-orange { background: #fff7ed; color: #ea580c; border: 1px solid #fed7aa; }

        .stat-meta { display: flex; flex-direction: column; }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: var(--text-muted); letter-spacing: 0.5px; }
        .stat-val { font-size: 2rem; font-weight: 800; line-height: 1; color: var(--text-main); }

        /* --- VM CARDS --- */
        .vm-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; margin-top: 40px; }
        .vm-col { width: 100%; max-width: 380px; }
        
        .vm-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 24px; padding: 24px;
            border: 1px solid white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            position: relative; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .vm-card:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }

        .status-badge {
            position: absolute; top: 20px; right: 20px;
            padding: 6px 12px; border-radius: 30px;
            font-size: 0.7rem; font-weight: 800;
            display: flex; align-items: center; gap: 6px;
        }
        .status-badge.run { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .status-badge.stop { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        .pulse-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* --- CONTROL DOCK (Branded) --- */
        .dock-container {
            margin-top: 25px; padding: 8px; border-radius: 16px;
            background: #f8fafc; border: 1px solid #e2e8f0;
            display: flex; justify-content: space-between;
        }
        .dock-btn {
            width: 42px; height: 42px; border-radius: 12px; border: none;
            background: white; color: #475569;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.2s; font-size: 1.1rem;
            display: flex; align-items: center; justify-content: center;
        }
        .dock-btn:hover { transform: scale(1.05); }
        .dock-btn.console:hover { background: #0f172a; color: white; } /* Noir terminal */
        .dock-btn.play:hover { background: #10b981; color: white; }   /* Vert start */
        .dock-btn.stop:hover { background: #f59e0b; color: white; }    /* Orange stop */
        .dock-btn.delete:hover { background: #ef4444; color: white; }  /* Rouge delete */

        /* --- DELETE MODAL (AWS STYLE) --- */
        .modal-danger-header { background: #fef2f2; color: #991b1b; padding: 20px; border-bottom: 1px solid #fee2e2; }
        .warning-box { background: #fff1f2; border-left: 4px solid #f43f5e; padding: 15px; margin-bottom: 20px; color: #881337; font-size: 0.9rem; }
        .delete-input { border: 2px solid #e2e8f0; padding: 10px; width: 100%; border-radius: 8px; font-weight: bold; }
        .delete-input:focus { border-color: #f43f5e; outline: none; }
        .btn-delete-confirm { 
            background: #dc2626; color: white; border: none; width: 100%; padding: 12px; 
            font-weight: 700; border-radius: 8px; opacity: 0.5; cursor: not-allowed; transition: 0.3s; 
        }
        .btn-delete-confirm.active { opacity: 1; cursor: pointer; }

        /* Metrics */
        .metric-group { text-align: center; }
        .metric-val { font-size: 1.4rem; font-weight: 800; color: var(--primary); }
        .metric-label { font-size: 0.7rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; }
        .progress-slim { height: 6px; background: #e2e8f0; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--primary); transition: width 0.5s; }

    </style>
</head>
<body>

    <nav class="navbar-glass">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="brand">
                <div class="brand-logo">N</div>
                <div>NEXUS <span>CLOUD</span></div>
            </div>
            <button class="btn btn-primary fw-bold px-4 py-2 rounded-3 shadow-sm" data-bs-toggle="modal" data-bs-target="#createVMModal">
                <i class="fas fa-plus me-2"></i>Nouvelle Instance
            </button>
        </div>
    </nav>

    <div class="container py-5">
        
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="nexus-circle nc-blue">N</div>
                    <div class="stat-meta">
                        <div class="stat-label">Instances Actives</div>
                        <div class="stat-val" id="total-running">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="nexus-circle nc-purple">N</div>
                    <div class="stat-meta">
                        <div class="stat-label">Cluster CPU</div>
                        <div class="stat-val" id="total-cpu">0%</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="nexus-circle nc-orange">N</div>
                    <div class="stat-meta">
                        <div class="stat-label">RAM Allouée</div>
                        <div class="stat-val" id="total-ram">0 Go</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="empty-state" style="display:none; text-align:center; padding: 60px; opacity:0.6;">
            <i class="fas fa-layer-group fa-4x mb-3 text-primary"></i>
            <h4>Prêt pour le déploiement</h4>
            <p>Le cluster NEXUS est opérationnel.</p>
        </div>

        <div class="vm-grid" id="vm-grid"></div>

    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 overflow-hidden">
                <div class="modal-danger-header">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Confirmation de Suppression</h5>
                </div>
                <div class="modal-body p-4">
                    <div class="warning-box">
                        Cette action est <strong>irréversible</strong>. La machine virtuelle et tous ses disques seront définitivement effacés.
                    </div>
                    
                    <p class="small text-muted mb-2">Pour confirmer, veuillez taper <strong class="text-dark" id="del-target-name"></strong> ci-dessous :</p>
                    
                    <input type="text" id="delete-confirm-input" class="delete-input" placeholder="Nom de la VM" onkeyup="checkDeleteInput()">
                    
                    <div class="mt-4">
                        <button id="btn-delete-final" class="btn-delete-confirm" onclick="executeDelete()">
                            Supprimer l'instance
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createVMModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-bottom-0 p-4 pb-0">
                    <h5 class="fw-bold">Configuration Instance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form action="/deploy" method="POST">
                        <div class="row g-4">
                            <div class="col-12">
                                <label class="form-label small fw-bold text-muted">Système</label>
                                <div class="d-flex gap-3">
                                    <div style="flex:1">
                                        <input type="radio" class="btn-check" name="os_type" id="os1" value="ubuntu" checked>
                                        <label class="btn btn-outline-primary w-100 py-2 fw-bold" for="os1">Ubuntu 22.04</label>
                                    </div>
                                    <div style="flex:1">
                                        <input type="radio" class="btn-check" name="os_type" id="os2" value="debian">
                                        <label class="btn btn-outline-danger w-100 py-2 fw-bold" for="os2">Debian 12</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6"><label class="small fw-bold text-muted">Nom</label><input name="hostname" class="form-control fw-bold" required></div>
                            <div class="col-md-6"><label class="small fw-bold text-muted">User</label><input name="username" class="form-control fw-bold" required></div>
                            <div class="col-12"><label class="small fw-bold text-muted">Mot de passe</label><input type="password" name="password" class="form-control" required></div>
                            <div class="col-4"><label class="small fw-bold text-muted">vCPU</label><input type="number" name="vcpu" class="form-control text-center" value="2" max="3"></div>
                            <div class="col-4"><label class="small fw-bold text-muted">RAM</label><input type="number" name="ram" class="form-control text-center" value="2048" step="1024" max="4096"></div>
                            <div class="col-4"><label class="small fw-bold text-muted">Disk</label><input type="number" name="disk" class="form-control text-center" value="10" max="50"></div>
                            <div class="col-12">
                                <div class="bg-light p-3 rounded">
                                    <div class="d-flex gap-3 mb-2">
                                        <div class="form-check"><input class="form-check-input" type="radio" name="ssh_method" value="paste" checked onclick="toggleSSH('paste')"><label class="fw-bold">Coller</label></div>
                                        <div class="form-check"><input class="form-check-input" type="radio" name="ssh_method" value="generate" onclick="toggleSSH('gen')"><label class="fw-bold">Générer</label></div>
                                    </div>
                                    <div id="ssh-paste-area"><input name="ssh_key_paste" class="form-control" placeholder="ssh-rsa ..."></div>
                                    <div id="ssh-gen-area" style="display:none"><input name="ssh_key_name" class="form-control" placeholder="Nom clé"></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4"><button class="btn btn-primary w-100 py-2 fw-bold rounded-3">Lancer</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="consoleModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white"><h5 class="mb-0">Terminal Access</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body bg-light">
                    <label class="small fw-bold">SSH</label>
                    <div class="input-group mb-3"><input id="ssh-cmd" class="form-control font-monospace" readonly><button class="btn btn-dark" onclick="copyToClip('ssh-cmd')"><i class="fas fa-copy"></i></button></div>
                    <label class="small fw-bold">SERIAL</label><div class="p-2 bg-dark text-white font-monospace rounded">virsh console <span id="virsh-vm-name"></span></div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        // --- LOGIQUE SUPPRESSION AWS STYLE ---
        let vmToDelete = "";
        
        function openDeleteModal(vmName) {
            vmToDelete = vmName;
            document.getElementById('del-target-name').innerText = vmName;
            document.getElementById('delete-confirm-input').value = "";
            document.getElementById('btn-delete-final').classList.remove('active');
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        function checkDeleteInput() {
            const input = document.getElementById('delete-confirm-input').value;
            const btn = document.getElementById('btn-delete-final');
            if(input === vmToDelete) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        function executeDelete() {
            if(!document.getElementById('btn-delete-final').classList.contains('active')) return;
            
            // On ferme le modal
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            
            // On lance l'API
            fetch(`/api/vm/${vmToDelete}/delete`, { method: 'POST' })
                .then(r => r.json())
                .then(d => { if(d.success) fetchStats(); else alert(d.msg); });
        }

        // --- COMMON LOGIC ---
        function toggleSSH(m) { document.getElementById('ssh-paste-area').style.display=m==='paste'?'block':'none'; document.getElementById('ssh-gen-area').style.display=m==='gen'?'block':'none'; }
        function copyToClip(id) { navigator.clipboard.writeText(document.getElementById(id).value); }
        function showConsole(n, ip) {
            document.getElementById('virsh-vm-name').innerText = n;
            document.getElementById('ssh-cmd').value = (ip && ip !== 'N/A') ? `ssh user@${ip}` : 'Waiting IP...';
            new bootstrap.Modal(document.getElementById('consoleModal')).show();
        }
        function controlVM(n, a) {
            // SI DELETE, ON PASSE PAR LA MODALE SPECIALE
            if (a === 'delete') { openDeleteModal(n); return; }
            
            fetch(`/api/vm/${n}/${a}`, { method: 'POST' }).then(r => r.json()).then(d => { if(d.success) fetchStats(); else alert(d.msg); });
        }

        let charts = {}, prevData = {};

        function fetchStats() {
            fetch('/api/monitor').then(r => r.json()).then(vms => {
                let running = vms.filter(v => v.status === 'Running').length;
                let totalRam = vms.reduce((acc, v) => acc + v.max_mem, 0) / 1024;
                document.getElementById('total-running').innerText = running;
                document.getElementById('total-ram').innerText = totalRam.toFixed(1) + " Go";
                document.getElementById('empty-state').style.display = vms.length === 0 ? 'block' : 'none';

                const names = vms.map(v => v.name);
                document.querySelectorAll('.vm-col').forEach(c => { if(!names.includes(c.id)) c.remove(); });
                const grid = document.getElementById('vm-grid');
                let globalCpuLoad = 0;

                vms.forEach(vm => {
                    let cpu = 0;
                    if (prevData[vm.name]) {
                        const dC = vm.cpu_time - prevData[vm.name].cpu_time;
                        const dT = vm.timestamp - prevData[vm.name].timestamp;
                        if (dT > 0) cpu = ((dC / 1e9) / dT / vm.vcpu) * 100;
                    }
                    prevData[vm.name] = vm;
                    cpu = parseFloat(Math.min(Math.max(cpu, 0), 100).toFixed(1));
                    if(vm.status === 'Running') globalCpuLoad += cpu;

                    let ramPct = vm.max_mem > 0 ? ((vm.used_mem / vm.max_mem) * 100).toFixed(1) : 0;
                    let col = document.getElementById(vm.name);
                    const isRun = vm.status === 'Running';
                    const statusClass = isRun ? 'run' : 'stop';
                    const statusText = isRun ? 'RUNNING' : 'STOPPED';
                    
                    const btnPlay = isRun 
                        ? `<button class="dock-btn stop" onclick="controlVM('${vm.name}','stop')" title="Arrêter"><i class="fas fa-power-off"></i></button>`
                        : `<button class="dock-btn play" onclick="controlVM('${vm.name}','start')" title="Démarrer"><i class="fas fa-play"></i></button>`;

                    if (!col) {
                        col = document.createElement('div');
                        col.className = 'vm-col';
                        col.id = vm.name;
                        col.innerHTML = `
                        <div class="vm-card">
                            <div class="status-badge ${statusClass}" id="badge-${vm.name}">
                                <div class="pulse-dot"></div> ${statusText}
                            </div>
                            
                            <h4 class="fw-bold mb-0 text-dark">${vm.name}</h4>
                            <div class="text-muted small fw-bold mb-4 font-monospace" id="ip-${vm.name}">...</div>

                            <div class="row text-center mb-3">
                                <div class="col-6 position-relative">
                                    <div style="height:70px; width:70px; margin:0 auto;"><canvas id="chart-${vm.name}"></canvas></div>
                                    <h4 class="metric-val mt-2 mb-0" id="ram-val-${vm.name}">0%</h4>
                                    <div class="metric-label">RAM</div>
                                </div>
                                <div class="col-6 d-flex flex-column justify-content-center">
                                    <h4 class="metric-val mb-0" id="cpu-val-${vm.name}">0%</h4>
                                    <div class="metric-label">CPU</div>
                                    <div class="progress-slim"><div class="progress-bar-fill" id="bar-${vm.name}" style="width:0%"></div></div>
                                </div>
                            </div>

                            <div class="dock-container">
                                <div id="btn-wrapper-${vm.name}">${btnPlay}</div>
                                <button class="dock-btn console" onclick="showConsole('${vm.name}','${vm.ip}')" title="Console"><i class="fas fa-terminal"></i></button>
                                <button class="dock-btn delete" onclick="controlVM('${vm.name}','delete')" title="Supprimer"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>`;
                        grid.appendChild(col);

                        const ctx = document.getElementById(`chart-${vm.name}`).getContext('2d');
                        charts[vm.name] = new Chart(ctx, {
                            type: 'doughnut',
                            data: { datasets: [{ data: [0, 100], backgroundColor: ['#2563eb', '#e2e8f0'], borderWidth: 0 }] },
                            options: { cutout: '75%', events: [], tooltips: { enabled: false } }
                        });
                    }

                    const badge = col.querySelector('.status-badge');
                    badge.className = `status-badge ${statusClass}`;
                    badge.innerHTML = `<div class="pulse-dot"></div> ${statusText}`;
                    
                    document.getElementById(`ip-${vm.name}`).innerText = vm.ip || '---';
                    document.getElementById(`cpu-val-${vm.name}`).innerText = cpu + '%';
                    document.getElementById(`ram-val-${vm.name}`).innerText = ramPct + '%';
                    document.getElementById(`bar-${vm.name}`).style.width = cpu + '%';
                    document.getElementById(`btn-wrapper-${vm.name}`).innerHTML = btnPlay;

                    if (charts[vm.name]) {
                        charts[vm.name].data.datasets[0].data = [vm.used_mem, vm.max_mem - vm.used_mem];
                        charts[vm.name].update();
                    }
                });
                
                let avgCpu = vms.length > 0 ? (globalCpuLoad / vms.length).toFixed(1) : 0;
                document.getElementById('total-cpu').innerText = avgCpu + '%';
            });
        }
        setInterval(fetchStats, 2000); fetchStats();
    </script>
</body>
</html>