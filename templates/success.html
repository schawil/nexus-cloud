<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Provisioning | NEXUS</title>
    <link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); /* Fond sombre immersif pour le focus */
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            color: white;
        }

        .focus-container {
            width: 100%;
            max-width: 480px;
            text-align: center;
        }

        /* CARD STYLE */
        .status-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 50px 100px -20px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        /* ANIMATIONS */
        .spinner-ring {
            width: 80px; height: 80px;
            border: 6px solid rgba(255, 255, 255, 0.1);
            border-top: 6px solid #38bdf8; /* Bleu cyan */
            border-radius: 50%;
            margin: 0 auto 30px auto;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .check-icon {
            font-size: 5rem; color: #4ade80; /* Vert fluo */
            display: none; margin-bottom: 20px;
            animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* TEXTE */
        h2 { font-weight: 800; margin-bottom: 10px; letter-spacing: -1px; }
        p { color: #94a3b8; font-size: 0.95rem; margin-bottom: 30px; }

        /* IP DISPLAY */
        .ip-reveal {
            background: #0f172a;
            border: 2px solid #38bdf8;
            color: #38bdf8;
            font-family: 'Courier New', monospace;
            font-size: 1.8rem;
            font-weight: bold;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 30px;
            display: none; /* Caché au début */
            box-shadow: 0 0 30px rgba(56, 189, 248, 0.2);
        }

        /* BOUTON (Caché au début) */
        .action-area { display: none; opacity: 0; transition: opacity 1s; }
        .btn-go {
            background: white; color: #0f172a;
            font-weight: 800; padding: 15px 40px; border-radius: 50px;
            text-decoration: none; display: inline-block;
            transition: transform 0.2s; border: none; width: 100%;
        }
        .btn-go:hover { transform: scale(1.05); background: #f8fafc; color: #0f172a; }

        .timer {
            font-family: monospace;
            color: #64748b;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        /* DOWNLOAD KEY BOX */
        .key-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #fbbf24;
            padding: 15px; border-radius: 12px; margin-bottom: 20px;
            text-align: left; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: space-between;
        }
    </style>
</head>
<body>

    <div class="focus-container">
        
        <div class="status-card">
            
            <div id="loader">
                <div class="spinner-ring"></div>
            </div>

            <i class="fas fa-check-circle check-icon" id="success-icon"></i>

            <h2 id="title-text">Initialisation...</h2>
            <p id="sub-text">Configuration du système et du réseau en cours.</p>

            <div class="ip-reveal" id="ip-box"></div>

            {% if key_download %}
            <div class="action-area" id="key-area">
                <div class="key-box">
                    <div><i class="fas fa-key me-2"></i>Clé générée</div>
                    <a href="/download_key/{{ key_download }}" class="btn btn-sm btn-warning fw-bold text-dark">Télécharger</a>
                </div>
            </div>
            {% endif %}

            <div class="action-area" id="final-actions">
                <a href="/" class="btn-go">Accéder au Dashboard</a>
            </div>

            <div class="timer"><i class="fas fa-stopwatch me-2"></i><span id="timer">0.0</span>s</div>
            <div id="timeout-msg" class="text-danger mt-3 fw-bold" style="display:none;">Délai dépassé. <a href="/" class="text-white">Forcer le retour</a></div>

        </div>

    </div>

    <script>
        const hostname = "{{ hostname }}";
        const statusEndpoint = `/api/monitor`; 
        let startTime = Date.now();
        let timerInterval;
        let attempts = 0;

        // 1. Chronomètre
        function startTimer() {
            timerInterval = setInterval(() => {
                let elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                document.getElementById('timer').innerText = elapsed;
                
                // Timeout Sécurité 60s
                if(elapsed > 60 && document.getElementById('ip-box').style.display === 'none') {
                    document.getElementById('timeout-msg').style.display = 'block';
                    document.getElementById('sub-text').innerText = "La VM met trop de temps à répondre.";
                }
            }, 100);
        }

        // 2. Polling Intelligent
        function checkStatus() {
            fetch(statusEndpoint)
                .then(r => r.json())
                .then(vms => {
                    const vm = vms.find(v => v.name === hostname);
                    
                    // On attend que l'IP soit valide (pas N/A, pas vide)
                    if (vm && vm.status === 'Running' && vm.ip && vm.ip.length > 6 && vm.ip !== 'N/A') {
                        finishProcess(vm.ip);
                    } else {
                        setTimeout(checkStatus, 1500); // Check toutes les 1.5s
                    }
                })
                .catch(e => setTimeout(checkStatus, 2000));
        }

        // 3. Affichage du succès
        function finishProcess(ip) {
            clearInterval(timerInterval);
            let finalTime = ((Date.now() - startTime) / 1000).toFixed(1);

            // Changement visuel
            document.getElementById('loader').style.display = 'none';
            document.getElementById('success-icon').style.display = 'block';
            
            document.getElementById('title-text').innerText = "VM Prête !";
            document.getElementById('sub-text').innerText = `Déploiement terminé en ${finalTime} secondes.`;
            
            // Affichage IP
            const ipBox = document.getElementById('ip-box');
            ipBox.innerText = ip;
            ipBox.style.display = 'block';

            // Affichage Boutons
            document.getElementById('final-actions').style.display = 'block';
            setTimeout(() => { document.getElementById('final-actions').style.opacity = '1'; }, 100);
            
            const keyArea = document.getElementById('key-area');
            if(keyArea) {
                keyArea.style.display = 'block';
                setTimeout(() => { keyArea.style.opacity = '1'; }, 100);
            }
        }

        startTimer();
        setTimeout(checkStatus, 2000); // Premier check après 2s
    </script>
</body>
</html>